import "reflect-metadata";
import { createDataSource } from "../common/data-source";
import { Company } from "./entities/Company";
import { Employee, ContactInfo, WorkInfo } from "./entities/Employee";
import { Address } from "./entities/Address";

async function runEmbeddedExample() {
  console.log("üì¶ Iniciando ejemplo de Objetos Embebidos...\n");

  // Crear DataSource espec√≠fico para este ejemplo
  const dataSource = createDataSource("embedded-example.sqlite", [
    Company,
    Employee,
  ]);

  try {
    // Inicializar DataSource
    await dataSource.initialize();
    console.log("‚úÖ Conexi√≥n a la base de datos establecida\n");

    // Obtener repositorios
    const companyRepository = dataSource.getRepository(Company);
    const employeeRepository = dataSource.getRepository(Employee);

    // === EJEMPLO 1: OBJETOS EMBEBIDOS B√ÅSICOS ===
    console.log("üè¢ Ejemplo 1: Direcciones Embebidas en Empresas");
    console.log("=".repeat(60));

    // Crear direcci√≥n principal
    const mainAddress = new Address();
    mainAddress.street = "Av. Corrientes 1234";
    mainAddress.city = "Buenos Aires";
    mainAddress.zipCode = "C1043AAZ";
    mainAddress.country = "Argentina";

    // Crear direcci√≥n de facturaci√≥n
    const billingAddress = new Address();
    billingAddress.street = "San Mart√≠n 567";
    billingAddress.city = "C√≥rdoba";
    billingAddress.zipCode = "X5000";
    billingAddress.country = "Argentina";

    // Crear empresa con direcciones embebidas
    const company1 = companyRepository.create({
      name: "TechCorp SA",
      email: "contact@techcorp.com",
      phone: "+54 11 1234-5678",
      website: "https://techcorp.com",
      mainAddress: mainAddress,
      billingAddress: billingAddress,
      tags: ["technology", "software", "innovation"],
      settings: {
        theme: "dark",
        notifications: true,
        language: "es",
        timezone: "America/Argentina/Buenos_Aires",
      },
    });

    await companyRepository.save(company1);
    console.log(`‚úÖ Empresa creada: ${company1.getDisplayName()}`);
    console.log(`üìç Ubicaci√≥n principal: ${company1.getMainLocation()}`);
    console.log(`üìÑ Facturaci√≥n: ${company1.getBillingLocation()}`);
    console.log(`üè∑Ô∏è  Tags: ${company1.getTagsDisplay()}`);
    console.log(
      `‚öôÔ∏è  Configuraci√≥n: Tema ${company1.settings.theme}, Idioma ${company1.settings.language}`
    );
    console.log(
      `üîÑ Misma direcci√≥n: ${company1.hasSameAddresses() ? "S√≠" : "No"}`
    );

    // Crear segunda empresa con direcciones iguales
    const sameAddress = new Address();
    sameAddress.street = "Florida 1000";
    sameAddress.city = "Buenos Aires";
    sameAddress.zipCode = "C1005AAP";
    sameAddress.country = "Argentina";

    const company2 = companyRepository.create({
      name: "StartupHub",
      email: "hello@startuphub.com",
      phone: "+54 11 9876-5432",
      mainAddress: sameAddress,
      billingAddress: sameAddress, // Misma direcci√≥n
      tags: ["startup", "incubator", "coworking"],
      settings: {
        theme: "light",
        notifications: false,
        language: "en",
        timezone: "UTC",
      },
    });

    await companyRepository.save(company2);
    console.log(`\n‚úÖ Empresa creada: ${company2.getDisplayName()}`);
    console.log(`üìç Ubicaci√≥n: ${company2.getMainLocation()}`);
    console.log(
      `üîÑ Misma direcci√≥n: ${company2.hasSameAddresses() ? "S√≠" : "No"}`
    );

    // === EJEMPLO 2: OBJETOS EMBEBIDOS COMPLEJOS ===
    console.log("\nüë• Ejemplo 2: Informaci√≥n Embebida en Empleados");
    console.log("=".repeat(60));

    // Crear empleado con informaci√≥n embebida compleja
    const employeeAddress = new Address();
    employeeAddress.street = "Libertador 2345";
    employeeAddress.city = "Buenos Aires";
    employeeAddress.zipCode = "C1425";
    employeeAddress.country = "Argentina";

    const employee1 = new Employee();
    employee1.firstName = "Mar√≠a";
    employee1.lastName = "Gonz√°lez";
    employee1.documentNumber = "12.345.678";
    employee1.homeAddress = employeeAddress;

    // Informaci√≥n de contacto embebida
    const contactInfo = new ContactInfo();
    contactInfo.email = "maria.gonzalez@techcorp.com";
    contactInfo.phone = "+54 11 5555-1234";
    contactInfo.emergencyContact = "Juan Gonz√°lez";
    contactInfo.emergencyPhone = "+54 11 5555-9999";
    employee1.contactInfo = contactInfo;

    // Informaci√≥n laboral embebida
    const workInfo = new WorkInfo();
    workInfo.department = "Engineering";
    workInfo.position = "Senior Developer";
    workInfo.salary = 150000;
    workInfo.hireDate = new Date("2020-03-15");
    workInfo.manager = "Carlos Rodriguez";
    employee1.workInfo = workInfo;

    // Skills y performance como JSON
    employee1.skills = [
      "JavaScript",
      "TypeScript",
      "React",
      "Node.js",
      "PostgreSQL",
    ];
    employee1.performance = {
      lastReview: new Date("2024-01-15"),
      rating: 4.5,
      goals: [
        "Lead junior developers",
        "Complete certification",
        "Improve system architecture",
      ],
      feedback:
        "Excellent performance, strong technical skills and great team collaboration",
    };

    await employeeRepository.save(employee1);
    console.log(`‚úÖ Empleado creado: ${employee1.getDisplayInfo()}`);
    console.log(`üìç Ubicaci√≥n: ${employee1.getLocation()}`);
    console.log(`üìû Contacto: ${employee1.contactInfo.getPrimaryContact()}`);
    console.log(
      `üÜò Emergencia: ${
        employee1.hasCompleteContactInfo() ? "Configurado" : "Pendiente"
      }`
    );
    console.log(
      `üíº Experiencia: ${employee1.workInfo.getYearsOfService()} a√±os (${
        employee1.isSeniorEmployee() ? "Senior" : "Junior"
      })`
    );
    console.log(`üéØ Skills: ${employee1.getSkillsDisplay()}`);
    console.log(`‚≠ê Rating: ${employee1.getPerformanceRating()}/5`);

    // Crear empleado junior
    const employee2Address = new Address();
    employee2Address.street = "Belgrano 890";
    employee2Address.city = "Rosario";
    employee2Address.zipCode = "S2000";
    employee2Address.country = "Argentina";

    const employee2 = new Employee();
    employee2.firstName = "Pedro";
    employee2.lastName = "Mart√≠nez";
    employee2.documentNumber = "87.654.321";
    employee2.homeAddress = employee2Address;

    const contactInfo2 = new ContactInfo();
    contactInfo2.email = "pedro.martinez@techcorp.com";
    contactInfo2.phone = "+54 341 5555-5678";
    contactInfo2.emergencyContact = undefined;
    contactInfo2.emergencyPhone = undefined;
    employee2.contactInfo = contactInfo2;

    const workInfo2 = new WorkInfo();
    workInfo2.department = "Engineering";
    workInfo2.position = "Junior Developer";
    workInfo2.salary = 80000;
    workInfo2.hireDate = new Date("2023-06-01");
    workInfo2.manager = "Mar√≠a Gonz√°lez";
    employee2.workInfo = workInfo2;

    employee2.skills = ["JavaScript", "React", "HTML", "CSS"];
    employee2.performance = {
      lastReview: new Date("2024-01-15"),
      rating: 3.8,
      goals: [
        "Learn TypeScript",
        "Complete onboarding",
        "First project delivery",
      ],
      feedback: "Great potential, eager to learn and improve",
    };

    await employeeRepository.save(employee2);
    console.log(`\n‚úÖ Empleado creado: ${employee2.getDisplayInfo()}`);
    console.log(`üìç Ubicaci√≥n: ${employee2.getLocation()}`);
    console.log(
      `üÜò Emergencia: ${
        employee2.hasCompleteContactInfo() ? "Configurado" : "Pendiente"
      }`
    );
    console.log(
      `üíº Experiencia: ${employee2.workInfo.getYearsOfService()} a√±os (${
        employee2.isSeniorEmployee() ? "Senior" : "Junior"
      })`
    );

    // === EJEMPLO 3: CONSULTAS CON OBJETOS EMBEBIDOS ===
    console.log("\nüîç Ejemplo 3: Consultas con Objetos Embebidos");
    console.log("=".repeat(60));

    // Buscar empresas por ciudad (campo embebido)
    const companiesInBuenosAires = await companyRepository
      .createQueryBuilder("company")
      .where("company.mainAddress_City = :city", { city: "Buenos Aires" })
      .getMany();

    console.log(
      `üè¢ Empresas en Buenos Aires: ${companiesInBuenosAires.length}`
    );
    companiesInBuenosAires.forEach((company) => {
      console.log(`  ‚Ä¢ ${company.name} - ${company.getMainLocation()}`);
    });

    // Buscar empleados por departamento (campo embebido)
    const engineeringEmployees = await employeeRepository
      .createQueryBuilder("employee")
      .where("employee.workInfo_Department = :dept", { dept: "Engineering" })
      .getMany();

    console.log(
      `\nüë®‚Äçüíª Empleados de Engineering: ${engineeringEmployees.length}`
    );
    engineeringEmployees.forEach((employee) => {
      console.log(`  ‚Ä¢ ${employee.getDisplayInfo()}`);
      console.log(
        `    üí∞ Salario: $${employee.workInfo.salary.toLocaleString()}`
      );
      console.log(`    üìä Rating: ${employee.getPerformanceRating()}/5`);
    });

    // Buscar empleados senior (usando m√©todo de negocio)
    const allEmployees = await employeeRepository.find();
    const seniorEmployees = allEmployees.filter((emp) =>
      emp.isSeniorEmployee()
    );

    console.log(`\nüéñÔ∏è  Empleados Senior: ${seniorEmployees.length}`);
    seniorEmployees.forEach((employee) => {
      console.log(
        `  ‚Ä¢ ${employee.getFullName()} - ${employee.workInfo.getYearsOfService()} a√±os`
      );
    });

    // === EJEMPLO 4: MANIPULACI√ìN DIN√ÅMICA ===
    console.log("\n‚öôÔ∏è  Ejemplo 4: Manipulaci√≥n Din√°mica de Objetos Embebidos");
    console.log("=".repeat(60));

    // Agregar skills a empleado
    employee2.addSkill("TypeScript");
    employee2.addSkill("Node.js");
    console.log(
      `üìö Skills actualizadas para ${employee2.getFullName()}: ${employee2.getSkillsDisplay()}`
    );

    // Actualizar performance
    employee2.updatePerformance(
      4.2,
      "Excellent progress in learning new technologies",
      [
        "Master TypeScript",
        "Build first full-stack project",
        "Mentor new interns",
      ]
    );
    console.log(
      `‚≠ê Performance actualizada: ${employee2.getPerformanceRating()}/5`
    );

    // Actualizar configuraci√≥n de empresa
    company1.updateSetting("theme", "light");
    company1.addTag("fintech");
    console.log(
      `üè∑Ô∏è  Tags actualizados para ${
        company1.name
      }: ${company1.getTagsDisplay()}`
    );

    // Guardar cambios
    await employeeRepository.save(employee2);
    await companyRepository.save(company1);
    console.log("‚úÖ Cambios guardados");

    // === ESTAD√çSTICAS FINALES ===
    console.log("\nüìä Estad√≠sticas Finales");
    console.log("=".repeat(60));

    const totalCompanies = await companyRepository.count();
    const totalEmployees = await employeeRepository.count();

    const companiesWithSameAddress =
      allEmployees.length > 0
        ? (await companyRepository.find()).filter((c) => c.hasSameAddresses())
            .length
        : 0;

    const employeesWithEmergencyContact = allEmployees.filter((e) =>
      e.hasCompleteContactInfo()
    ).length;

    const avgSalary =
      allEmployees.length > 0
        ? allEmployees.reduce((sum, emp) => sum + emp.workInfo.salary, 0) /
          allEmployees.length
        : 0;

    console.log(`üè¢ Total empresas: ${totalCompanies}`);
    console.log(`üë• Total empleados: ${totalEmployees}`);
    console.log(`üìç Empresas con misma direcci√≥n: ${companiesWithSameAddress}`);
    console.log(
      `üÜò Empleados con contacto de emergencia: ${employeesWithEmergencyContact}/${totalEmployees}`
    );
    console.log(`üí∞ Salario promedio: $${avgSalary.toLocaleString()}`);

    console.log("\n‚úÖ Ejemplo de objetos embebidos completado exitosamente!");
  } catch (error) {
    console.error("‚ùå Error ejecutando el ejemplo:", error);
  } finally {
    // Cerrar conexi√≥n
    if (dataSource.isInitialized) {
      await dataSource.destroy();
      console.log("üîê Conexi√≥n cerrada");
    }
  }
}

// Ejecutar el ejemplo
runEmbeddedExample().catch(console.error);
